### 3.6.2 TCP协议

#### 一、概述

**TCP****通信**：面向连接的通信，客户端和服务器端必须经过3次握手，建立逻辑连接，才能通信（安全）。

 

**通信的步骤：**

服务器端先启动

服务器端不会主动请求客户端，必须使用客户端请求服务器端。

客户端和服务器端就会建立一个逻辑连接，而这个连接中包含一个对象，这个对象就是IO对象。

客户端和服务器端就可以使用IO对象进行通信。

通信的数据不仅仅是字符，所以IO对象是**字节流对象**。

 

服务器端：配置高的计算机ip:端口号 ServerSocket类

客户端：配置低的计算机ip:端口号 Socekt类

**步骤：**

1、客户端给服务器端发送数据，OutputStream：你好服务器

2、服务器端读取客户端发送的数据InputStream：你好服务器

3、服务器端给客户端发送数据，OutputStream：收到谢谢

4.客户端读取服务器端发送的数据，InputStream：收到谢谢

 

客户端和服务器端进行一次数据交互，需要4个IO流对象。

 

**服务器端必须明确两件事情**：

1、多个客户端同时和服务器进行交互，服务器必须明确和哪个客户端进行的交互。

à在服务器端，有一个方法叫accept可以获取到请求的客户端对象。

2、服务器同时和多个客户端进行交互，需要使用多个IO流对象。

à服务器是没有IO流的，服务器可以获取到请求的客户端对象Socekt，使用每个客户端Socekt中提供的IO流和客户端进行交互。服务器使用客户端的字节输入流读取客户端发送的数据，服务器使用客户端的字节数出流给客户端回写（发送）数据。

**简单记：服务器使用客户端的流和客户端交互。**

（我请你吃饭，但是没钱，和你借10元请你吃饭）

 

#### 二、客户端实现

**（一）TCP****通信的客户端**：像服务器端发送连接请求，给服务器端发送数据，读取服务器回写的数据。

表示客户端的类：java.net.Socekt此类实现客户端套接字（也可以就叫“套接字”）。套接字是两台机器间通信的端点。

套接字：包含了IP地址和端口号的网络单位。
 

**（二）构造方法：**

Socket(String host, int port) 创建一个流套接字并将其连接到指定主机上的指定端口号。

参数：String host服务器主机的名称/服务器的IP地址，int port服务器的端口号。


 **（三）成员方法：**
 OutputStream getOutputStream()返回此套接字的输出流。
 InputStream getInputStream()返回此套接字的输入流。
 void close()关闭此套接字。
 

**（四）实现步骤：**

1、创建一个客户端对象Socket，构造方法中绑定服务器的IP地址和端口号；
 2、使用Socket对象中的方法getOutputStream获取网络字节输出流OutputStream对象；
 3、使用网络字节输出流对象OutputStream中的方法write方法，给服务器发送数据；
 4、使用Socket对象中的方法getInputStream获取网络字节输入流InputStream对象；
 5、使用网络字节输入流InputStream对象中的read方法读取服务器回写的数据；
 6、释放资源（Socket）
 

**（五）注意：**
 1、客户端和服务器端进行交互，必须使用Socket提供的网络流，不能使用自己创建的流对象；
 2、当我们创建客户端对象Socket时，就会去请求服务器和服务器经过3次握手建立连接通路。
   如果服务器没有启动，那么就会抛出异常。ConnectException: Connection refused: connect
   如果服务器已经启动，那么就可以进行交互了。

```
public class TCPClient {
    public static void main(String[] args) throws IOException {
        //1、创建一个客户端对象Socket，构造方法中绑定服务器的IP地址和端口号；
        Socket socket = new Socket("127.0.0.1", 8888);
        // 2、使用Socket对象中的方法getOutputStream获取网络字节输出流OutputStream对象；
        OutputStream os = socket.getOutputStream();
        //3、使用网络字节输出流对象OutputStream中的方法write方法，给服务器发送数据；
        os.write("你好呀，服务器".getBytes());
        //4、使用Socket对象中的方法getInputStream获取网络字节输入流InputStream对象；
        InputStream is = socket.getInputStream();
        //5、使用网络字节输入流InputStream对象中的方法读取服务器回写的数据；
        byte[] bytes = new byte[1024];
        int len = is.read(bytes);
        System.out.println(new String(bytes, 0, len));
        //6、释放资源（Socket）
        socket.close();
    }
}
```

 

#### 三、服务器端实现

**（一）TCP****通信的服务器端**：接收客户端的请求，读取客户端发送的数据，给客户端回写数据。

表示服务器的类：java.net.ServerSocket此类实现服务器套接字。
 
 **（二）构造方法：**
 ServerSocket(int port) 创建绑定到特定端口的服务器套接字。
 服务器端必须明确一件事情，必须得知道是哪个客户端请求的服务器，所以可以使用accept方法获取到请求的客户端对象Socket。
 成员方法：
 Socket accept() 侦听并接受到此套接字的连接。
 
 **（三）服务器的实现步骤**：
 1、创建服务器ServerSocket对象合系统要指定的端口号；
 2、使用ServerSocket对象对象中的accept获取到请求的客户端对象Socket；
 3、使用Socket对象中的方法getInputStream获取网络字节输入流InputStream对象；
 4、使用网络字节输入流InputStream对象中的read方法,读取客户端发送的数据；
 5、使用Socket对象中的方法getOutputStream获取网络字节输出流OutputStream对象
 6、使用网络字节输出流对象OutputStream中的方法write方法，给服客户端回写数据；
 7、释放资源（Socket,ServerSocket）

```
public class TCPServer {
    public static void main(String[] args) throws IOException {
        //1、创建服务器ServerSocket对象合系统要指定的端口号；
        ServerSocket server = new ServerSocket(8888);
        //2、使用ServerSocket对象对象中的accept获取到请求的客户端对象Socket；
        Socket socket = server.accept();
        //3、使用Socket对象中的方法getInputStream获取网络字节输入流InputStream对象；
        InputStream is = socket.getInputStream();
        //4、使用网络字节输入流InputStream对象中的read方法,读取客户端发送的数据；
        byte[] bytes = new byte[1024];
        int len = is.read(bytes);
        System.out.println(new String(bytes, 0, len));
        //5、使用Socket对象中的方法getOutputStream获取网络字节输出流OutputStream对象
        OutputStream os = socket.getOutputStream();
        //6、使用网络字节输出流对象OutputStream中的方法write方法，给服客户端回写数据；
        os.write("收到，谢谢！".getBytes());
        //7、释放资源（Socket,ServerSocket）
        socket.close();
        server.close();
    }
}
```

 

#### 四、TCP通信的文件上传综合案例

**（一）原理**

客户端读取本地的文件，把文件上传到服务器，服务器再把上传的文件保存到服务器的硬盘上。（上传图片值QQ空间，发邮件附件）

**（二）思路**

1、客户端使用**本地的字节输入流**读取要上传的文件；

2、客户端使用**网络字节输出流**把读取到的文件上传到服务器；

3、服务器使用**网络字节输入流**读取客户端上传的文件；

4、服务器使用**本地的字节输出流**把读取到的文件保存到服务器的硬盘上；

5、服务器使用**网络字节输出流**给客户端回写一个“上传成功！”；

6、客户端使用**网络字节输入流**速去服务器回写的数据；

7、释放资源

注意：

客户端和服务器对本地硬盘进行读写，需要使用自己创建的字节流对象（本地流）；

客户端和服务器之间进行读写，必须使用Socket中提供的字节流对象（网络流。）

文件上传的原理：就是文件的复制。

明确：数据源（D:\\1.png）、数据目的地（服务器硬盘：F:\\upload\\1.png）

​                               

**（三）服务器端：**

 

```
public class TCPServer {
    public static void main(String[] args) throws IOException {
        //3、服务器使用网络字节输入流读取客户端上传的文件；
        ServerSocket server = new ServerSocket(8888);
        /*让服务器一直处于监听状态（死循环accept方法）
        有一个客户端上传文件，就保存一个文件 */
        while (true) {
            Socket socket = server.accept();
            /*使用多线程提高程序效率
            有一个客户端上传文件，就开启一个线程，完成文件的上传   */
            new Thread(new Runnable() {
                @Override
                public void run() {
                    //完成文件的上传
                    try {
                        InputStream is = socket.getInputStream();
                        //判断f盘是否有upload文件夹，没有则创建
                        File file = new File("F:\\upload");
                        if (!file.exists()) {
                            file.mkdir();  //不存在就创建
                        }
                         /*
                         自定义一个文件命名规则，防止被覆盖
                         规则：域名+毫秒值+随机数
                          */
                        String fileName = "LCH" + System.currentTimeMillis() + new Random().nextInt(999999) + ".jpg";
                        //创建本地字节输出流
                        FileOutputStream fos = new FileOutputStream(file + "\\" + fileName);
                        //接收客户端端发送的文件
                        byte[] bytes = new byte[1024];
                        int len = 0;  //读取文件
                        while ((len = is.read(bytes)) != -1) {
                            fos.write(bytes, 0, len);
                        }
                        //5、服务器使用网络字节输出流给客户端回写一个“上传成功！”；
                        //创建服务器字节输出流
                        OutputStream os = socket.getOutputStream();
                        //向服务器端发送此文件
                        os.write("上传成功！".getBytes());
                        //释放资源
                        fos.close();
                        socket.close();
                    } catch (IOException e) {
                        System.out.println(e);
                    }
                }
            }).start();
        }
        //服务器一直启动，就不用关闭了
        //server.close();
    }
}
```

**（四）客户端**

void shutdownOutput() 禁用此套接字的输出流。
 对于 TCP 套接字，任何以前写入的数据都将被发送，并且后跟 TCP 的正常连接终止序列。

 

```
public class TCPClient {
    public static void main(String[] args) throws IOException {
        //创建本地字节输入流
        FileInputStream fis = new FileInputStream("D:\\1.jpg");
        //创建客户端对象
        Socket socket = new Socket("127.0.0.1", 8888);
        //创建客户端字节输出流
        OutputStream os = socket.getOutputStream();
        //使用read方法读取本地文件
        byte[] bytes = new byte[1024];
        int len = 0;
        while ((len=fis.read(bytes)) != -1) {
            //向服务器端发送此文件
            os.write(bytes, 0, len);
        }
        //增加一个结束标记
        socket.shutdownOutput();
        //接收服务器端发送的消息
        InputStream is = socket.getInputStream();
        while ((len=is.read(bytes)) != -1) {
            //打印服务器发送过来的消息
            System.out.println(new String(bytes, 0, len));
        }
        //释放资源
        fis.close();
        socket.close();
    }
}
```

 

3.6.3 B/S案例